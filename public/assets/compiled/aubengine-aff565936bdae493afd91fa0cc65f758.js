function resizeCanvas(t){c_width=$("#content").width(),c_height=$("#content").height(),$("#the-canvas").attr("width",c_width),$("#the-canvas").attr("height",c_height),t&&t.draw()}function Animation(t,e,r,i,n){this.frequency=t,this.interval=null,n?(this.callbackObj=n,n.callback=r):this.callbackObj={callback:r};var o,a=0,s=this;this.onFrame=function(){var r=function(){clearInterval(s.interval)};if(o=(new Date).getTime()-s.iTime,!(5>o)){for(var n=Math.floor(o/t);n>0&&a!=e;)s.callbackObj.callback(i),n-=1,a++;a==e&&r(),s.iTime=(new Date).getTime()}},this.startAnimation=function(){s.iTime=(new Date).getTime(),s.interval=setInterval(s.onFrame,s.frequency/1e3)}}function Transformation(t,e,r,i){this.name=t,this.mv=null,this.position=e||[0,0,0],this.size=r||[1,1,1],this.rotation=i||{angle:0,axis:[0,0,0]},this.animations=[]}function Texture(t){this.texture=gl.createTexture(),this.image=new Image;var e=this;this.image.src=t,this.image.onload=function(){gl.bindTexture(gl.TEXTURE_2D,e.texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e.image),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.generateMipmap(gl.TEXTURE_2D),gl.bindTexture(gl.TEXTURE_2D,null)}}function Light(t){this.id=t,this.position=[0,0,0],this.ambient=[0,0,0,0],this.diffuse=[0,0,0,0],this.specular=[0,0,0,0]}function Mesh(t,e,r){this.filename=t,this.alias=e,this.ambient=null,this.diffuse=null,this.specular=null,this.wireframe=null,this.vertices=null,this.indices=null,this.scalars=null,this.texture_coords=null,this.texture=r||null,this.image=null,this.tbo=null,this.cbo=null,this.nbo=null,this.ibo=null,this.vbo=null,this.remote=null,this.Ni=1,this.Ka=[0,0,0],this.d=1,this.Kd=[.8,.80842,.64],this.illum=2,this.Ks=[.94944,.94944,.94944],this.Ns=96.07843,this.position=null,this.size=null,this.rotation=null}function Camera(t,e,r,i,n){this.alias=t,this.matrix=mat4.create(),this.up=vec3.create(),this.right=vec3.create(),this.normal=vec3.create(),this.position=vec3.create(),this.focus=vec3.create(),this.azimuth=0,this.elevation=0,this.type=e,this.steps=0,this.home=vec3.create(),this.tHome=vec3.create(),this.tFocus=r,this.tAzimuth=i,this.tElevation=n}function CameraInteractor(t,e){this.camera=t,this.canvas=e,this.update(),this.dragging=!1,this.picking=!1,this.x=0,this.y=0,this.lastX=0,this.lastY=0,this.button=0,this.ctrl=!1,this.key=0,this.MOTION_FACTOR=10,this.dloc=0,this.dstep=0,this.picker=null}function SceneTransforms(t){this.stack=[],this.camera=t,this.mvMatrix=mat4.create(),this.pMatrix=mat4.create(),this.nMatrix=mat4.create()}function NodeTree(t,e,r){this.entity=t||"",this.children=r||[],e?e.addChild(this):this.father=""}function Tree(){this.root=new NodeTree,this.isDraw=!1}function Aubengine(t){this.interactor=null,this.transforms=null,this.tree=new Tree,gl=Configuration.getGLContext(t),this.camera=null,this.canvas=t,initialTime=void 0,elapsedTime=void 0,this.frequency=5}!function(t){t.glMatrixArrayType=t.MatrixArray=null,t.vec3={},t.mat3={},t.mat4={},t.quat4={},t.setMatrixArrayType=function(t){return glMatrixArrayType=MatrixArray=t},t.determineMatrixArrayType=function(){return setMatrixArrayType("undefined"!=typeof Float32Array?Float32Array:Array)},determineMatrixArrayType()}("undefined"!=typeof exports?global:this),vec3.create=function(t){var e=new MatrixArray(3);return t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):e[0]=e[1]=e[2]=0,e},vec3.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},vec3.add=function(t,e,r){return r&&t!==r?(r[0]=t[0]+e[0],r[1]=t[1]+e[1],r[2]=t[2]+e[2],r):(t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t)},vec3.subtract=function(t,e,r){return r&&t!==r?(r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],r):(t[0]-=e[0],t[1]-=e[1],t[2]-=e[2],t)},vec3.multiply=function(t,e,r){return r&&t!==r?(r[0]=t[0]*e[0],r[1]=t[1]*e[1],r[2]=t[2]*e[2],r):(t[0]*=e[0],t[1]*=e[1],t[2]*=e[2],t)},vec3.negate=function(t,e){return e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},vec3.scale=function(t,e,r){return r&&t!==r?(r[0]=t[0]*e,r[1]=t[1]*e,r[2]=t[2]*e,r):(t[0]*=e,t[1]*=e,t[2]*=e,t)},vec3.normalize=function(t,e){e||(e=t);var r=t[0],i=t[1],n=t[2],o=Math.sqrt(r*r+i*i+n*n);return o?1===o?(e[0]=r,e[1]=i,e[2]=n,e):(o=1/o,e[0]=r*o,e[1]=i*o,e[2]=n*o,e):(e[0]=0,e[1]=0,e[2]=0,e)},vec3.cross=function(t,e,r){r||(r=t);var i=t[0],n=t[1],t=t[2],o=e[0],a=e[1],e=e[2];return r[0]=n*e-t*a,r[1]=t*o-i*e,r[2]=i*a-n*o,r},vec3.length=function(t){var e=t[0],r=t[1],t=t[2];return Math.sqrt(e*e+r*r+t*t)},vec3.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},vec3.direction=function(t,e,r){r||(r=t);var i=t[0]-e[0],n=t[1]-e[1],t=t[2]-e[2],e=Math.sqrt(i*i+n*n+t*t);return e?(e=1/e,r[0]=i*e,r[1]=n*e,r[2]=t*e,r):(r[0]=0,r[1]=0,r[2]=0,r)},vec3.lerp=function(t,e,r,i){return i||(i=t),i[0]=t[0]+r*(e[0]-t[0]),i[1]=t[1]+r*(e[1]-t[1]),i[2]=t[2]+r*(e[2]-t[2]),i},vec3.dist=function(t,e){var r=e[0]-t[0],i=e[1]-t[1],n=e[2]-t[2];return Math.sqrt(r*r+i*i+n*n)},vec3.unproject=function(t,e,r,i,n){n||(n=t);var o=mat4.create(),a=new MatrixArray(4);return a[0]=2*(t[0]-i[0])/i[2]-1,a[1]=2*(t[1]-i[1])/i[3]-1,a[2]=2*t[2]-1,a[3]=1,mat4.multiply(r,e,o),mat4.inverse(o)?(mat4.multiplyVec4(o,a),0===a[3]?null:(n[0]=a[0]/a[3],n[1]=a[1]/a[3],n[2]=a[2]/a[3],n)):null},vec3.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+"]"},mat3.create=function(t){var e=new MatrixArray(9);return t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8]),e},mat3.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},mat3.identity=function(t){return t||(t=mat3.create()),t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},mat3.transpose=function(t,e){if(!e||t===e){var r=t[1],i=t[2],n=t[5];return t[1]=t[3],t[2]=t[6],t[3]=r,t[5]=t[7],t[6]=i,t[7]=n,t}return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],e},mat3.toMat4=function(t,e){return e||(e=mat4.create()),e[15]=1,e[14]=0,e[13]=0,e[12]=0,e[11]=0,e[10]=t[8],e[9]=t[7],e[8]=t[6],e[7]=0,e[6]=t[5],e[5]=t[4],e[4]=t[3],e[3]=0,e[2]=t[2],e[1]=t[1],e[0]=t[0],e},mat3.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+"]"},mat4.create=function(t){var e=new MatrixArray(16);return t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e},mat4.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},mat4.identity=function(t){return t||(t=mat4.create()),t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},mat4.transpose=function(t,e){if(!e||t===e){var r=t[1],i=t[2],n=t[3],o=t[6],a=t[7],s=t[11];return t[1]=t[4],t[2]=t[8],t[3]=t[12],t[4]=r,t[6]=t[9],t[7]=t[13],t[8]=i,t[9]=o,t[11]=t[14],t[12]=n,t[13]=a,t[14]=s,t}return e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e},mat4.determinant=function(t){var e=t[0],r=t[1],i=t[2],n=t[3],o=t[4],a=t[5],s=t[6],l=t[7],u=t[8],c=t[9],h=t[10],f=t[11],g=t[12],m=t[13],d=t[14],t=t[15];return g*c*s*n-u*m*s*n-g*a*h*n+o*m*h*n+u*a*d*n-o*c*d*n-g*c*i*l+u*m*i*l+g*r*h*l-e*m*h*l-u*r*d*l+e*c*d*l+g*a*i*f-o*m*i*f-g*r*s*f+e*m*s*f+o*r*d*f-e*a*d*f-u*a*i*t+o*c*i*t+u*r*s*t-e*c*s*t-o*r*h*t+e*a*h*t},mat4.inverse=function(t,e){e||(e=t);var r=t[0],i=t[1],n=t[2],o=t[3],a=t[4],s=t[5],l=t[6],u=t[7],c=t[8],h=t[9],f=t[10],g=t[11],m=t[12],d=t[13],p=t[14],v=t[15],y=r*s-i*a,T=r*l-n*a,x=r*u-o*a,A=i*l-n*s,b=i*u-o*s,M=n*u-o*l,N=c*d-h*m,R=c*p-f*m,E=c*v-g*m,C=h*p-f*d,L=h*v-g*d,_=f*v-g*p,w=y*_-T*L+x*C+A*E-b*R+M*N;return w?(w=1/w,e[0]=(s*_-l*L+u*C)*w,e[1]=(-i*_+n*L-o*C)*w,e[2]=(d*M-p*b+v*A)*w,e[3]=(-h*M+f*b-g*A)*w,e[4]=(-a*_+l*E-u*R)*w,e[5]=(r*_-n*E+o*R)*w,e[6]=(-m*M+p*x-v*T)*w,e[7]=(c*M-f*x+g*T)*w,e[8]=(a*L-s*E+u*N)*w,e[9]=(-r*L+i*E-o*N)*w,e[10]=(m*b-d*x+v*y)*w,e[11]=(-c*b+h*x-g*y)*w,e[12]=(-a*C+s*R-l*N)*w,e[13]=(r*C-i*R+n*N)*w,e[14]=(-m*A+d*T-p*y)*w,e[15]=(c*A-h*T+f*y)*w,e):null},mat4.toRotationMat=function(t,e){return e||(e=mat4.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},mat4.toMat3=function(t,e){return e||(e=mat3.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},mat4.toInverseMat3=function(t,e){var r=t[0],i=t[1],n=t[2],o=t[4],a=t[5],s=t[6],l=t[8],u=t[9],c=t[10],h=c*a-s*u,f=-c*o+s*l,g=u*o-a*l,m=r*h+i*f+n*g;return m?(m=1/m,e||(e=mat3.create()),e[0]=h*m,e[1]=(-c*i+n*u)*m,e[2]=(s*i-n*a)*m,e[3]=f*m,e[4]=(c*r-n*l)*m,e[5]=(-s*r+n*o)*m,e[6]=g*m,e[7]=(-u*r+i*l)*m,e[8]=(a*r-i*o)*m,e):null},mat4.multiply=function(t,e,r){r||(r=t);var i=t[0],n=t[1],o=t[2],a=t[3],s=t[4],l=t[5],u=t[6],c=t[7],h=t[8],f=t[9],g=t[10],m=t[11],d=t[12],p=t[13],v=t[14],t=t[15],y=e[0],T=e[1],x=e[2],A=e[3],b=e[4],M=e[5],N=e[6],R=e[7],E=e[8],C=e[9],L=e[10],_=e[11],w=e[12],F=e[13],P=e[14],e=e[15];return r[0]=y*i+T*s+x*h+A*d,r[1]=y*n+T*l+x*f+A*p,r[2]=y*o+T*u+x*g+A*v,r[3]=y*a+T*c+x*m+A*t,r[4]=b*i+M*s+N*h+R*d,r[5]=b*n+M*l+N*f+R*p,r[6]=b*o+M*u+N*g+R*v,r[7]=b*a+M*c+N*m+R*t,r[8]=E*i+C*s+L*h+_*d,r[9]=E*n+C*l+L*f+_*p,r[10]=E*o+C*u+L*g+_*v,r[11]=E*a+C*c+L*m+_*t,r[12]=w*i+F*s+P*h+e*d,r[13]=w*n+F*l+P*f+e*p,r[14]=w*o+F*u+P*g+e*v,r[15]=w*a+F*c+P*m+e*t,r},mat4.multiplyVec3=function(t,e,r){r||(r=e);var i=e[0],n=e[1],e=e[2];return r[0]=t[0]*i+t[4]*n+t[8]*e+t[12],r[1]=t[1]*i+t[5]*n+t[9]*e+t[13],r[2]=t[2]*i+t[6]*n+t[10]*e+t[14],r},mat4.multiplyVec4=function(t,e,r){r||(r=e);var i=e[0],n=e[1],o=e[2],e=e[3];return r[0]=t[0]*i+t[4]*n+t[8]*o+t[12]*e,r[1]=t[1]*i+t[5]*n+t[9]*o+t[13]*e,r[2]=t[2]*i+t[6]*n+t[10]*o+t[14]*e,r[3]=t[3]*i+t[7]*n+t[11]*o+t[15]*e,r},mat4.translate=function(t,e,r){var i,n,o,a,s,l,u,c,h,f,g,m,d=e[0],p=e[1],e=e[2];return r&&t!==r?(i=t[0],n=t[1],o=t[2],a=t[3],s=t[4],l=t[5],u=t[6],c=t[7],h=t[8],f=t[9],g=t[10],m=t[11],r[0]=i,r[1]=n,r[2]=o,r[3]=a,r[4]=s,r[5]=l,r[6]=u,r[7]=c,r[8]=h,r[9]=f,r[10]=g,r[11]=m,r[12]=i*d+s*p+h*e+t[12],r[13]=n*d+l*p+f*e+t[13],r[14]=o*d+u*p+g*e+t[14],r[15]=a*d+c*p+m*e+t[15],r):(t[12]=t[0]*d+t[4]*p+t[8]*e+t[12],t[13]=t[1]*d+t[5]*p+t[9]*e+t[13],t[14]=t[2]*d+t[6]*p+t[10]*e+t[14],t[15]=t[3]*d+t[7]*p+t[11]*e+t[15],t)},mat4.scale=function(t,e,r){var i=e[0],n=e[1],e=e[2];return r&&t!==r?(r[0]=t[0]*i,r[1]=t[1]*i,r[2]=t[2]*i,r[3]=t[3]*i,r[4]=t[4]*n,r[5]=t[5]*n,r[6]=t[6]*n,r[7]=t[7]*n,r[8]=t[8]*e,r[9]=t[9]*e,r[10]=t[10]*e,r[11]=t[11]*e,r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15],r):(t[0]*=i,t[1]*=i,t[2]*=i,t[3]*=i,t[4]*=n,t[5]*=n,t[6]*=n,t[7]*=n,t[8]*=e,t[9]*=e,t[10]*=e,t[11]*=e,t)},mat4.rotate=function(t,e,r,i){var n,o,a,s,l,u,c,h,f,g,m,d,p,v,y,T,x,A,b,M,N=r[0],R=r[1],r=r[2],E=Math.sqrt(N*N+R*R+r*r);return E?(1!==E&&(E=1/E,N*=E,R*=E,r*=E),n=Math.sin(e),o=Math.cos(e),a=1-o,e=t[0],E=t[1],s=t[2],l=t[3],u=t[4],c=t[5],h=t[6],f=t[7],g=t[8],m=t[9],d=t[10],p=t[11],v=N*N*a+o,y=R*N*a+r*n,T=r*N*a-R*n,x=N*R*a-r*n,A=R*R*a+o,b=r*R*a+N*n,M=N*r*a+R*n,N=R*r*a-N*n,R=r*r*a+o,i?t!==i&&(i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[0]=e*v+u*y+g*T,i[1]=E*v+c*y+m*T,i[2]=s*v+h*y+d*T,i[3]=l*v+f*y+p*T,i[4]=e*x+u*A+g*b,i[5]=E*x+c*A+m*b,i[6]=s*x+h*A+d*b,i[7]=l*x+f*A+p*b,i[8]=e*M+u*N+g*R,i[9]=E*M+c*N+m*R,i[10]=s*M+h*N+d*R,i[11]=l*M+f*N+p*R,i):null},mat4.rotateX=function(t,e,r){var i=Math.sin(e),e=Math.cos(e),n=t[4],o=t[5],a=t[6],s=t[7],l=t[8],u=t[9],c=t[10],h=t[11];return r?t!==r&&(r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]):r=t,r[4]=n*e+l*i,r[5]=o*e+u*i,r[6]=a*e+c*i,r[7]=s*e+h*i,r[8]=n*-i+l*e,r[9]=o*-i+u*e,r[10]=a*-i+c*e,r[11]=s*-i+h*e,r},mat4.rotateY=function(t,e,r){var i=Math.sin(e),e=Math.cos(e),n=t[0],o=t[1],a=t[2],s=t[3],l=t[8],u=t[9],c=t[10],h=t[11];return r?t!==r&&(r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]):r=t,r[0]=n*e+l*-i,r[1]=o*e+u*-i,r[2]=a*e+c*-i,r[3]=s*e+h*-i,r[8]=n*i+l*e,r[9]=o*i+u*e,r[10]=a*i+c*e,r[11]=s*i+h*e,r},mat4.rotateZ=function(t,e,r){var i=Math.sin(e),e=Math.cos(e),n=t[0],o=t[1],a=t[2],s=t[3],l=t[4],u=t[5],c=t[6],h=t[7];return r?t!==r&&(r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]):r=t,r[0]=n*e+l*i,r[1]=o*e+u*i,r[2]=a*e+c*i,r[3]=s*e+h*i,r[4]=n*-i+l*e,r[5]=o*-i+u*e,r[6]=a*-i+c*e,r[7]=s*-i+h*e,r},mat4.frustum=function(t,e,r,i,n,o,a){a||(a=mat4.create());var s=e-t,l=i-r,u=o-n;return a[0]=2*n/s,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*n/l,a[6]=0,a[7]=0,a[8]=(e+t)/s,a[9]=(i+r)/l,a[10]=-(o+n)/u,a[11]=-1,a[12]=0,a[13]=0,a[14]=-(2*o*n)/u,a[15]=0,a},mat4.perspective=function(t,e,r,i,n){return t=r*Math.tan(t*Math.PI/360),e*=t,mat4.frustum(-e,e,-t,t,r,i,n)},mat4.ortho=function(t,e,r,i,n,o,a){a||(a=mat4.create());var s=e-t,l=i-r,u=o-n;return a[0]=2/s,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/l,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/u,a[11]=0,a[12]=-(t+e)/s,a[13]=-(i+r)/l,a[14]=-(o+n)/u,a[15]=1,a},mat4.lookAt=function(t,e,r,i){i||(i=mat4.create());var n,o,a,s,l,u,c,h,f=t[0],g=t[1],t=t[2];return a=r[0],s=r[1],o=r[2],c=e[0],r=e[1],n=e[2],f===c&&g===r&&t===n?mat4.identity(i):(e=f-c,r=g-r,c=t-n,h=1/Math.sqrt(e*e+r*r+c*c),e*=h,r*=h,c*=h,n=s*c-o*r,o=o*e-a*c,a=a*r-s*e,(h=Math.sqrt(n*n+o*o+a*a))?(h=1/h,n*=h,o*=h,a*=h):a=o=n=0,s=r*a-c*o,l=c*n-e*a,u=e*o-r*n,(h=Math.sqrt(s*s+l*l+u*u))?(h=1/h,s*=h,l*=h,u*=h):u=l=s=0,i[0]=n,i[1]=s,i[2]=e,i[3]=0,i[4]=o,i[5]=l,i[6]=r,i[7]=0,i[8]=a,i[9]=u,i[10]=c,i[11]=0,i[12]=-(n*f+o*g+a*t),i[13]=-(s*f+l*g+u*t),i[14]=-(e*f+r*g+c*t),i[15]=1,i)},mat4.fromRotationTranslation=function(t,e,r){r||(r=mat4.create());var i=t[0],n=t[1],o=t[2],a=t[3],s=i+i,l=n+n,u=o+o,t=i*s,c=i*l,i=i*u,h=n*l,n=n*u,o=o*u,s=a*s,l=a*l,a=a*u;return r[0]=1-(h+o),r[1]=c+a,r[2]=i-l,r[3]=0,r[4]=c-a,r[5]=1-(t+o),r[6]=n+s,r[7]=0,r[8]=i+l,r[9]=n-s,r[10]=1-(t+h),r[11]=0,r[12]=e[0],r[13]=e[1],r[14]=e[2],r[15]=1,r},mat4.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+"]"},quat4.create=function(t){var e=new MatrixArray(4);return t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]),e},quat4.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},quat4.calculateW=function(t,e){var r=t[0],i=t[1],n=t[2];return e&&t!==e?(e[0]=r,e[1]=i,e[2]=n,e[3]=-Math.sqrt(Math.abs(1-r*r-i*i-n*n)),e):(t[3]=-Math.sqrt(Math.abs(1-r*r-i*i-n*n)),t)},quat4.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},quat4.inverse=function(t,e){var r=t[0],i=t[1],n=t[2],o=t[3],r=(r=r*r+i*i+n*n+o*o)?1/r:0;return e&&t!==e?(e[0]=-t[0]*r,e[1]=-t[1]*r,e[2]=-t[2]*r,e[3]=t[3]*r,e):(t[0]*=-r,t[1]*=-r,t[2]*=-r,t[3]*=r,t)},quat4.conjugate=function(t,e){return e&&t!==e?(e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e):(t[0]*=-1,t[1]*=-1,t[2]*=-1,t)},quat4.length=function(t){var e=t[0],r=t[1],i=t[2],t=t[3];return Math.sqrt(e*e+r*r+i*i+t*t)},quat4.normalize=function(t,e){e||(e=t);var r=t[0],i=t[1],n=t[2],o=t[3],a=Math.sqrt(r*r+i*i+n*n+o*o);return 0===a?(e[0]=0,e[1]=0,e[2]=0,e[3]=0,e):(a=1/a,e[0]=r*a,e[1]=i*a,e[2]=n*a,e[3]=o*a,e)},quat4.multiply=function(t,e,r){r||(r=t);var i=t[0],n=t[1],o=t[2],t=t[3],a=e[0],s=e[1],l=e[2],e=e[3];return r[0]=i*e+t*a+n*l-o*s,r[1]=n*e+t*s+o*a-i*l,r[2]=o*e+t*l+i*s-n*a,r[3]=t*e-i*a-n*s-o*l,r},quat4.multiplyVec3=function(t,e,r){r||(r=e);var i=e[0],n=e[1],o=e[2],e=t[0],a=t[1],s=t[2],t=t[3],l=t*i+a*o-s*n,u=t*n+s*i-e*o,c=t*o+e*n-a*i,i=-e*i-a*n-s*o;return r[0]=l*t+i*-e+u*-s-c*-a,r[1]=u*t+i*-a+c*-e-l*-s,r[2]=c*t+i*-s+l*-a-u*-e,r},quat4.toMat3=function(t,e){e||(e=mat3.create());var r=t[0],i=t[1],n=t[2],o=t[3],a=r+r,s=i+i,l=n+n,u=r*a,c=r*s,r=r*l,h=i*s,i=i*l,n=n*l,a=o*a,s=o*s,o=o*l;return e[0]=1-(h+n),e[1]=c+o,e[2]=r-s,e[3]=c-o,e[4]=1-(u+n),e[5]=i+a,e[6]=r+s,e[7]=i-a,e[8]=1-(u+h),e},quat4.toMat4=function(t,e){e||(e=mat4.create());var r=t[0],i=t[1],n=t[2],o=t[3],a=r+r,s=i+i,l=n+n,u=r*a,c=r*s,r=r*l,h=i*s,i=i*l,n=n*l,a=o*a,s=o*s,o=o*l;return e[0]=1-(h+n),e[1]=c+o,e[2]=r-s,e[3]=0,e[4]=c-o,e[5]=1-(u+n),e[6]=i+a,e[7]=0,e[8]=r+s,e[9]=i-a,e[10]=1-(u+h),e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},quat4.slerp=function(t,e,r,i){i||(i=t);var n,o,a=t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3];return 1<=Math.abs(a)?(i!==t&&(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3]),i):(n=Math.acos(a),o=Math.sqrt(1-a*a),.001>Math.abs(o)?(i[0]=.5*t[0]+.5*e[0],i[1]=.5*t[1]+.5*e[1],i[2]=.5*t[2]+.5*e[2],i[3]=.5*t[3]+.5*e[3],i):(a=Math.sin((1-r)*n)/o,r=Math.sin(r*n)/o,i[0]=t[0]*a+e[0]*r,i[1]=t[1]*a+e[1]*r,i[2]=t[2]*a+e[2]*r,i[3]=t[3]*a+e[3]*r,i))},quat4.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+"]"};var gl=null,prg=null,c_width=0,c_height=0,names=["webgl","experimental-webgl","webkit-3d","moz-webgl"],interactor=null,transforms=null;$(window).resize(function(){resizeCanvas()});var Configuration={getGLContext:function(t){var e=document.getElementById(t),r=null;if(null==e)return alert("Hey! There is no canvas!"),null;c_width=e.width,c_height=e.height;for(var i=0;i<names.length;++i){try{r=e.getContext(names[i])}catch(n){}if(r)break}return null==r?(alert("Sorry! Not posible to initialize :("),null):r},requestAnimFrame:function(t){requestAnimFrame(t)},calculateNormals:function(t,e){for(var r=0,i=1,n=2,o=[],a=0;a<t.length;a+=3)o[a+r]=0,o[a+i]=0,o[a+n]=0;for(var a=0;a<e.length;a+=3){var s=[],l=[],u=[];for(s[r]=t[3*e[a+2]+r]-t[3*e[a+1]+r],s[i]=t[3*e[a+2]+i]-t[3*e[a+1]+i],s[n]=t[3*e[a+2]+n]-t[3*e[a+1]+n],l[r]=t[3*e[a]+r]-t[3*e[a+1]+r],l[i]=t[3*e[a]+i]-t[3*e[a+1]+i],l[n]=t[3*e[a]+n]-t[3*e[a+1]+n],u[r]=s[i]*l[n]-s[n]*l[i],u[i]=s[n]*l[r]-s[r]*l[n],u[n]=s[r]*l[i]-s[i]*l[r],j=0;3>j;j++)o[3*e[a+j]+r]=o[3*e[a+j]+r]+u[r],o[3*e[a+j]+i]=o[3*e[a+j]+i]+u[i],o[3*e[a+j]+n]=o[3*e[a+j]+n]+u[n]}for(var a=0;a<t.length;a+=3){var c=[];c[r]=o[a+r],c[i]=o[a+i],c[n]=o[a+n];var h=Math.sqrt(c[r]*c[r]+c[i]*c[i]+c[n]*c[n]);0==h&&(h=1),c[r]=c[r]/h,c[i]=c[i]/h,c[n]=c[n]/h,o[a+r]=c[r],o[a+i]=c[i],o[a+n]=c[n]}return o},calculateTangents:function(t,e,r){var i,n=[];for(i=0;i<t.length/3;i++)n[i]=[0,0,0];var o=[0,0,0],a=[0,0,0],s=[0,0,0];for(i=0;i<r.length;i+=3){var l=r[i+0],u=r[i+1],c=r[i+2],h=[t[3*l],t[3*l+1],t[3*l+2]],f=[t[3*u],t[3*u+1],t[3*u+2]],g=[t[3*c],t[3*c+1],t[3*c+2]],m=[e[2*l],e[2*l+1]],d=[e[2*u],e[2*u+1]],p=[e[2*c],e[2*c+1]];vec3.subtract(f,h,o),vec3.subtract(g,h,a);var v=(d[0]-m[0],d[1]-m[1]),y=(p[0]-m[0],p[0]-m[1]);s=[y*o[0]-v*a[0],y*o[1]-v*a[1],y*o[2]-v*a[2]],vec3.add(n[l],s),vec3.add(n[u],s),vec3.add(n[c],s)}var T=[];for(i=0;i<n.length;i++){var x=n[i];vec3.normalize(x),T.push(x[0]),T.push(x[1]),T.push(x[2])}return T}};Transformation.prototype.getPosition=function(){return this.position},Transformation.prototype.startAnimation=function(){this.animations.forEach(function(t){t.startAnimation()})},Transformation.prototype.copy=function(){var t=this,e=new Transformation(t.name,t.position,t.size,t.rotation);return e},Transformation.prototype.beginDraw=function(){transforms.push(),transforms.calculateModelView(),this.mv=transforms.mvMatrix,null!=this.position&&mat4.translate(this.mv,this.position),null!=this.size&&mat4.scale(this.mv,this.size),null!=this.rotation&&mat4.rotate(this.mv,this.rotation.angle*Math.PI/180,this.rotation.axis),transforms.setMatrixUniforms(),console.log("begin draw "+this.name)},Transformation.prototype.endDraw=function(){transforms.pop(),console.log("end draw "+this.name)},Transformation.prototype.rotate=function(t){t[0].angle=t[1].angle+t[0].angle,vec3.add(t[0].axis,t[1].axis,t[0].axis)},Transformation.prototype.translate=function(t){vec3.add(t[0],t[1],t[0])},Transformation.prototype.scale=function(t){vec3.add(t[0],t[1],t[0])},Transformation.prototype.animate=function(t,e,r,i,n){this.animations.push(new Animation(t,e,r,i,n))},Texture.prototype.getTexture=function(){return this.texture},Light.prototype.setPosition=function(t){this.position=t.slice(0)},Light.prototype.setDiffuse=function(t){this.diffuse=t.slice(0)},Light.prototype.setAmbient=function(t){this.ambient=t.slice(0)},Light.prototype.setSpecular=function(t){this.specular=t.slice(0)},Light.prototype.setProperty=function(t,e){if("string"!=typeof t)throw"The property name must be a string";this[t]=e instanceof Array?e.slice(0):e},Light.prototype.beginDraw=function(t){var e=this;Lights.draw(e,t),console.log("beginDraw of "+this.id)},Light.prototype.endDraw=function(){console.log("endDraw of "+this.id)};var Lights={list:[],add:function(t,e){return t instanceof Light?(t.setPosition(e),void this.list.push(t)):void alert("the parameter is not a light")},getArray:function(t){for(var e=[],r=0,i=this.list.length;i>r;r+=1)e=e.concat(this.list[r][t]);return e},get:function(t){if("number"==typeof t&&t>=0&&t<this.list.length)return this.list[t];if("string"==typeof t){for(var e=0,r=this.list.length;r>e;e+=1)if(this.list[e].id==t)return this.list[e];throw"Light "+t+" does not exist"}throw"Unknown parameter"},setNumLights:function(){return this.list.length<=0?4:this.list.length},draw:function(){gl.uniform3fv(Program.uLightPosition,Lights.getArray("position")),gl.uniform3fv(Program.uLa,Lights.getArray("ambient")),gl.uniform3fv(Program.uLd,Lights.getArray("diffuse")),gl.uniform3fv(Program.uLs,Lights.getArray("specular")),gl.uniform3fv(Program.uKa,[1,1,1]),gl.uniform3fv(Program.uKd,[1,1,1]),gl.uniform3fv(Program.uKs,[1,1,1]),gl.uniform1f(Program.uNs,1),gl.uniform1i(Program.uTranslateLights,!0)}},Shaders={vertex:{type:"x-shader/x-vertex",content:"const int NUM_LIGHTS ="+Lights.setNumLights()+";\n   attribute vec3 aVertexPosition;\n   attribute vec3 aVertexNormal;\n   attribute vec4 aVertexColor;\n   attribute vec2 aVertexTextureCoords;\n   uniform mat4 uMVMatrix;\n   uniform mat4 uPMatrix;\n   uniform mat4 uNMatrix;\n   uniform bool uTranslateLights;\n   uniform vec3 uLightPosition[NUM_LIGHTS];\n   varying vec3 vNormal;\n   varying vec3 vLightRay[NUM_LIGHTS];\n   varying vec3 vEye[NUM_LIGHTS];\n   varying vec2 vTextureCoord;\n   void main(void) {\n        vec4 c = aVertexColor;\n        vec4 vertex = uMVMatrix * vec4(aVertexPosition, 1.0);\n        vNormal = vec3(uNMatrix * vec4(aVertexNormal, 1.0));\n        vec4 lightPosition = vec4(0.0);\n        if (uTranslateLights){             for(int i=0; i < NUM_LIGHTS; i++){               lightPosition =   uMVMatrix * vec4(uLightPosition[i], 1.0);\n              vLightRay[i] = vertex.xyz - lightPosition.xyz;\n              vEye[i] = -vec3(vertex.xyz);\n            }\n        }\n        else {\n           for(int i=0; i < NUM_LIGHTS; i++){\n             lightPosition = vec4(uLightPosition[i], 1.0);\n             vLightRay[i] = vertex.xyz - lightPosition.xyz;\n             vEye[i] = -vec3(vertex.xyz);\n           }\n       }\n       gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);\n       vTextureCoord = aVertexTextureCoords;\n   }\n"},fragment:{type:"x-shader/x-fragment",content:"#ifdef GL_ES\nprecision highp float;\n#endif\n  const int NUM_LIGHTS ="+Lights.setNumLights()+";\n  uniform vec3  uLa[NUM_LIGHTS];\n  uniform vec3  uLd[NUM_LIGHTS];\n  uniform vec3  uLs[NUM_LIGHTS];\n  uniform vec3  uLightPosition[NUM_LIGHTS];\n  uniform vec3  uKa;\n  uniform vec3  uKd;\n  uniform vec3  uKs;\n  uniform float uNs;\n  uniform float d;\n  uniform int   illum;\n  uniform bool  uWireframe;\n  uniform bool  uTextures;\n  uniform sampler2D uSampler;\n  varying vec3 vNormal;\n  varying vec3 vLightRay[NUM_LIGHTS];\n  varying vec3 vEye[NUM_LIGHTS];\n  varying vec2 vTextureCoord;\n  float calculateAttenuation(in vec3 ray){\n      float dist = length(ray);\n      return (1.0 / (0.1 * dist));\n  }\n  void main(void) {\n      if (uWireframe || illum == 0){\n          gl_FragColor = vec4(uKd,d);\n          return;\n      }\n     vec3 COLOR = vec3(0.0,0.0,0.0);\n     vec3 N =  normalize(vNormal);\n     vec3 L =  vec3(0.0,0.0,0.0);\n     vec3 E =  vec3(0.0,0.0,0.0);\n     vec3 R =  vec3(0.0,0.0,0.0);\n     vec3 deltaRay = vec3(0.0);\n     const int  lsize = 2;\n     const float step = 0.25;\n     const float inv_total = 1.0/((float(lsize*lsize) + 1.0)*(float(lsize*lsize) + 1.0));\n     float dx = 0.0;\n     float dz = 0.0;\n     float LT = 0.0;\n     if (illum == 1){\n          for(int i = 0; i < NUM_LIGHTS; i++){\n              L = normalize(vLightRay[i]);\n              N = normalize(vNormal);\n              COLOR += (uLa[i] * uKa) + (uLd[i] * uKd * clamp(dot(N, -L),0.0,1.0));\n          }\n       if (uTextures){\n         gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n       } else {\n         gl_FragColor =  vec4(COLOR,d);\n       }\n       return;\n     }\n     if (illum == 2){\n          for(int i = 0; i < NUM_LIGHTS; i++){\n              E = normalize(vEye[i]);\n              L = normalize(vLightRay[i]);\n              R = reflect(L, N);\n              COLOR += (uLa[i] * uKa);\n              COLOR += (uLd[i] * uKd * clamp(dot(N,-L),0.0,1.0));\n              COLOR += (uLs[i] * uKs * pow( max(dot(R, E), 0.0), uNs) * 4.0);\n          }\n       if (uTextures){\n         gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n       } else {\n         gl_FragColor = vec4(COLOR,d);\n       }\n       return;\n     }\n  }\n"}},Program={attributeList:["aVertexPosition","aVertexNormal","aVertexColor","aVertexTextureCoords"],uniformList:["uPMatrix","uMVMatrix","uNMatrix","uLightPosition","uWireframe","uLa","uLd","uLs","uKa","uKd","uKs","uNs","d","illum","uTranslateLights","uSampler","uTextures"],getShader:function(t,e){var r,i,n=Shaders[e].content,o=Shaders[e].type;if("x-shader/x-fragment"==o)r=t.createShader(t.FRAGMENT_SHADER),i="Fragment Shader";else{if("x-shader/x-vertex"!=o)return null;r=t.createShader(t.VERTEX_SHADER),i="Vertex Shader"}return t.shaderSource(r,n),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)?r:(alert("There was a problem with the "+i+":\n\n"+t.getShaderInfoLog(r)),null)},load:function(){var t=Program.getShader(gl,"fragment"),e=Program.getShader(gl,"vertex");prg=gl.createProgram(),gl.attachShader(prg,e),gl.attachShader(prg,t),gl.bindAttribLocation(prg,0,"aVertexPosition"),gl.linkProgram(prg),gl.getProgramParameter(prg,gl.LINK_STATUS)||alert("Could not initialise shaders"),gl.useProgram(prg),gl.enableVertexAttribArray(0),this.setAttributeLocations(this.attributeList),this.setUniformLocations(this.uniformList)},setAttributeLocations:function(t){for(var e=0,r=t.length;r>e;e+=1)this[t[e]]=gl.getAttribLocation(prg,t[e])},setUniformLocations:function(t){for(var e=0,r=t.length;r>e;e+=1)this[t[e]]=gl.getUniformLocation(prg,t[e])},getUniform:function(t){return gl.getUniform(prg,t)}};Mesh.prototype.getAlias=function(){return this.alias},Mesh.prototype.getFilename=function(){return this.filename},Mesh.prototype.setSpecularColor=function(t,e,r){this.Kd=Color.rgb2decimal(t,e,r)},Mesh.prototype.getPosition=function(){return this.position},Mesh.prototype.setPosition=function(t){this.position=t},Mesh.prototype.getRotation=function(){return this.rotation},Mesh.prototype.setRotation=function(t){this.rotation=t},Mesh.prototype.setSize=function(t){this.size=t},Mesh.prototype.getSize=function(){return this.size},Mesh.prototype.setSpecular=function(t){this.Ns=t},Mesh.prototype.getAttributes=function(){var t={Ni:this.Ni,Ka:this.Ka,d:this.d,Kd:this.Kd,illum:this.illum,Ks:this.Ks,Ns:this.Ns,texture:this.texture};return t},Mesh.prototype.defaultCoords=function(){return[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1]},Mesh.prototype.draw=function(){try{var t=Scene.getObject(this.getAlias());gl.uniform1i(Program.uWireframe,!1),t.texture_coords?gl.uniform1i(Program.uTextures,!0):gl.uniform1i(Program.uTextures,!1),gl.uniform3fv(Program.uKa,t.Ka),gl.uniform3fv(Program.uKd,t.Kd),gl.uniform3fv(Program.uKs,t.Ks),gl.uniform1f(Program.uNs,t.Ns),gl.uniform1f(Program.d,t.d),gl.uniform1i(Program.illum,t.illum),gl.enableVertexAttribArray(Program.aVertexPosition),gl.disableVertexAttribArray(Program.aVertexNormal),gl.disableVertexAttribArray(Program.aVertexColor),gl.bindBuffer(gl.ARRAY_BUFFER,t.vbo),gl.vertexAttribPointer(Program.aVertexPosition,3,gl.FLOAT,!1,0,0),gl.enableVertexAttribArray(Program.aVertexPosition),t.d<1&&gl.uniform1f(Program.d,.14),t.texture_coords&&(gl.enableVertexAttribArray(Program.aVertexTextureCoords),gl.bindBuffer(gl.ARRAY_BUFFER,t.tbo),gl.vertexAttribPointer(Program.aVertexTextureCoords,2,gl.FLOAT,!1,0,0),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,t.texture.texture),gl.uniform1i(Program.uSampler,0)),t.wireframe?gl.uniform1i(Program.uWireframe,!0):(gl.bindBuffer(gl.ARRAY_BUFFER,t.nbo),gl.vertexAttribPointer(Program.aVertexNormal,3,gl.FLOAT,!1,0,0),gl.enableVertexAttribArray(Program.aVertexNormal)),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,t.ibo),t.wireframe?gl.drawElements(gl.LINES,t.indices.length,gl.UNSIGNED_SHORT,0):gl.drawElements(gl.TRIANGLES,t.indices.length,gl.UNSIGNED_SHORT,0),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null)}catch(e){console.error(e.description)}},Mesh.prototype.beginDraw=function(){console.log("beginDraw of"+this.alias),this.draw()},Mesh.prototype.endDraw=function(){console.log("endDraw of "+this.alias)};var Scene={objects:[],getObject:function(t){for(var e=0,r=Scene.objects.length;r>e;e++)if(t==Scene.objects[e].alias)return Scene.objects[e];return null},loadObject:function(t,e,r,i){var n=new XMLHttpRequest;console.info("Requesting "+t),n.open("GET",t),n.onreadystatechange=function(){if(4==n.readyState)if(404==n.status)console.info(t+" does not exist");else{var o=JSON.parse(n.responseText);o.alias=null==e?"none":e,o.remote=!0,Scene.addObject(o,r,i)}},n.send()},loadObjectByParts:function(t,e,r){for(var i=1;r>=i;i++){var n=t+""+i+".json",o=e+""+i;Scene.loadObject(n,o)}},addObject:function(t,e){void 0===t.wireframe&&(t.wireframe=!1),void 0===t.texture&&(t.texture=!1),void 0===t.diffuse&&(t.diffuse=[1,1,1,1]),void 0===t.ambient&&(t.ambient=[.2,.2,.2,1]),void 0===t.specular&&(t.specular=[1,1,1,1]),t.texture_coords?gl.uniform1i(Program.uTextures,!0):gl.uniform1i(Program.uTextures,!1);for(var r in e)t[r]=e[r];var i=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,i),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(t.vertices),gl.STATIC_DRAW);var n=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,n),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(Configuration.calculateNormals(t.vertices,t.indices)),gl.STATIC_DRAW);var o;t.scalars&&(o=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,o),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(t.scalars),gl.STATIC_DRAW),t.cbo=o);var a,s;t.texture_coords&&(a=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,a),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(t.texture_coords),gl.STATIC_DRAW),t.tbo=a,s=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,s),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(Configuration.calculateTangents(t.vertices,t.texture_coords,t.indices)),gl.STATIC_DRAW),gl.bindBuffer(gl.ARRAY_BUFFER,null),t.tanbo=s);var l=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,l),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(t.indices),gl.STATIC_DRAW),t.vbo=i,t.ibo=l,t.nbo=n,gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null),gl.bindBuffer(gl.ARRAY_BUFFER,null),Scene.objects.push(t),console.info(t.remote?t.alias+" has been added to the scene [Remote]":t.alias+" has been added to the scene [Local]")},removeObject:function(t){var e=this.getObject(t),r=this.objects.indexOf(e);this.objects.splice(r,1)},renderFirst:function(t){var e=this.getObject(t),r=this.objects.indexOf(e);0!=r&&(this.objects.splice(r,1),this.objects.splice(0,0,e),console.info("render order:"+this.renderOrder()))},renderLast:function(t){var e=this.getObject(t),r=this.objects.indexOf(e);0!=r&&(this.objects.splice(r,1),this.objects.push(e),console.info("render order:"+this.renderOrder()))},renderSooner:function(t){var e=this.getObject(t),r=this.objects.indexOf(e);0!=r&&(this.objects.splice(r,1),this.objects.splice(r-1,0,e),console.info("render order:"+this.renderOrder()))},renderLater:function(t){var e=this.getObject(t),r=this.objects.indexOf(e);r!=this.objects.length-1&&(this.objects.splice(r,1),this.objects.splice(r+1,0,e),console.info("render order:"+this.renderOrder()))},renderOrder:function(){for(var t="[ ",e=0,r=this.objects.length;r>e;e++)t+=this.objects[e].alias+" ";return t+="]"}},Axis={alias:"axis",dim:10,vertices:[-10,0,0,10,0,0,0,-5,0,0,5,0,0,0,-10,0,0,10],indices:[0,1,2,3,4,5],colors:[1,1,0,1,1,1,0,1,0,1,0,1,0,1,0,1,0,0,1,1,0,0,1,1],wireframe:!0,perVertexColor:!0,build:function(t){t&&(Axis.dim=t),Axis.vertices=[-t,0,0,t,0,0,0,-t/2,0,0,t/2,0,0,0,-t,0,0,t]}},Floor={alias:"floor",wireframe:!0,dim:50,lines:50,vertices:[],indices:[],diffuse:[.7,.7,.7,1],build:function(t,e){t&&(Floor.dim=t),e&&(Floor.lines=2*Floor.dim/e);
for(var r=2*Floor.dim/Floor.lines,i=[],n=[],o=0;o<=Floor.lines;o++)i[6*o]=-Floor.dim,i[6*o+1]=0,i[6*o+2]=-Floor.dim+o*r,i[6*o+3]=Floor.dim,i[6*o+4]=0,i[6*o+5]=-Floor.dim+o*r,i[6*(Floor.lines+1)+6*o]=-Floor.dim+o*r,i[6*(Floor.lines+1)+6*o+1]=0,i[6*(Floor.lines+1)+6*o+2]=-Floor.dim,i[6*(Floor.lines+1)+6*o+3]=-Floor.dim+o*r,i[6*(Floor.lines+1)+6*o+4]=0,i[6*(Floor.lines+1)+6*o+5]=Floor.dim,n[2*o]=2*o,n[2*o+1]=2*o+1,n[2*(Floor.lines+1)+2*o]=2*(Floor.lines+1)+2*o,n[2*(Floor.lines+1)+2*o+1]=2*(Floor.lines+1)+2*o+1;Floor.vertices=i,Floor.indices=n}},Color={hex2rgb:function(t,e){var r=t.replace("#",""),i=parseInt(r.substring(0,2),16),n=parseInt(r.substring(2,4),16),o=parseInt(r.substring(4,6),16);return[i/255,n/255,o/255,e]},rgb2hex:function(t){return"#"+("0"+parseInt(t[0],10).toString(16)).slice(-2)+("0"+parseInt(t[1],10).toString(16)).slice(-2)+("0"+parseInt(t[2],10).toString(16)).slice(-2)},rgb2decimal:function(t,e,r){return[t/255,e/255,r/255]}},CAMERA_ORBITING_TYPE=1,CAMERA_TRACKING_TYPE=2;Camera.prototype.isMain=function(){return this.main},Camera.prototype.setType=function(t){this.type=t,t!=CAMERA_ORBITING_TYPE&&t!=CAMERA_TRACKING_TYPE&&(alert("Wrong Camera Type!. Setting Orbitting type by default"),this.type=CAMERA_ORBITING_TYPE)},Camera.prototype.getAlias=function(){return this.alias},Camera.prototype.goHome=function(t){null!=t&&(this.home=t),this.setPosition(this.home),this.setAzimuth(0),this.setElevation(0),this.steps=0},Camera.prototype.dolly=function(t){var e=this,r=vec3.create(),i=vec3.create();r=e.position;var n=t-e.steps;vec3.normalize(e.normal,i);var o=vec3.create();e.type==CAMERA_TRACKING_TYPE?(o[0]=r[0]-n*i[0],o[1]=r[1]-n*i[1],o[2]=r[2]-n*i[2]):(o[0]=r[0],o[1]=r[1],o[2]=r[2]-n),e.setPosition(o),e.steps=t},Camera.prototype.setHome=function(t){vec3.set(t,this.tHome)},Camera.prototype.setPosition=function(t){vec3.set(t,this.position),vec3.set(t,this.tHome),this.update()},Camera.prototype.setFocus=function(t){vec3.set(t,this.focus),this.update()},Camera.prototype.setAzimuth=function(t){this.changeAzimuth(t-this.azimuth)},Camera.prototype.changeAzimuth=function(t){var e=this;e.azimuth+=t,(e.azimuth>360||e.azimuth<-360)&&(e.azimuth=e.azimuth%360),e.update()},Camera.prototype.setElevation=function(t){this.changeElevation(t-this.elevation)},Camera.prototype.changeElevation=function(t){var e=this;e.elevation+=t,(e.elevation>360||e.elevation<-360)&&(e.elevation=e.elevation%360),e.update()},Camera.prototype.calculateOrientation=function(){var t=this.matrix;mat4.multiplyVec4(t,[1,0,0,0],this.right),mat4.multiplyVec4(t,[0,1,0,0],this.up),mat4.multiplyVec4(t,[0,0,1,0],this.normal)},Camera.prototype.update=function(){if(mat4.identity(this.matrix),this.calculateOrientation(),this.type==CAMERA_TRACKING_TYPE)mat4.translate(this.matrix,this.position),mat4.rotateY(this.matrix,this.azimuth*Math.PI/180),mat4.rotateX(this.matrix,this.elevation*Math.PI/180);else{{mat4.create()}mat4.rotateY(this.matrix,this.azimuth*Math.PI/180),mat4.rotateX(this.matrix,this.elevation*Math.PI/180),mat4.translate(this.matrix,this.position)}this.calculateOrientation(),this.type==CAMERA_TRACKING_TYPE&&mat4.multiplyVec4(this.matrix,[0,0,0,1],this.position)},Camera.prototype.getViewTransform=function(){var t=mat4.create();return mat4.inverse(this.matrix,t),t},Camera.prototype.draw=function(){this.goHome(this.tHome),this.setFocus(this.tFocus),this.setAzimuth(this.tAzimuth),this.setElevation(this.tElevation)},Camera.prototype.beginDraw=function(){this.draw(),console.log("beginDraw of "+this.alias)},Camera.prototype.endDraw=function(){console.log("endDraw of "+this.alias)};var Cameras={list:[],add:function(t,e){return t instanceof Camera?(t.setPosition(e),void this.list.push(t)):void alert("the parameter is not a light")},getArray:function(t){for(var e=[],r=0,i=this.list.length;i>r;r+=1)e=e.concat(this.list[r][t]);return e},get:function(t){if("number"==typeof t&&t>=0&&t<this.list.length)return this.list[t];if("string"==typeof t){for(var e=0,r=this.list.length;r>e;e+=1)if(this.list[e].alias==t)return this.list[e];throw"Camera "+t+" does not exist"}throw"Unknown parameter"},getNumCameras:function(){return this.list.length<=0?1:this.list.length}};CameraInteractor.prototype.setPicker=function(t){this.picker=t},CameraInteractor.prototype.get2DCoords=function(t){for(var e,r,i=0,n=0,o=this.canvas;o&&"BODY"!=o.tagName;)i+=o.offsetTop,n+=o.offsetLeft,o=o.offsetParent;return n+=window.pageXOffset,i+=window.pageYOffset,e=t.clientX-n,r=c_height-(t.clientY-i),{x:e,y:r}},CameraInteractor.prototype.onMouseUp=function(t){this.dragging=!1,t.shiftKey||(this.picking=!1,this.picker&&this.picker.stop())},CameraInteractor.prototype.onMouseDown=function(t){if(this.dragging=!0,this.x=t.clientX,this.y=t.clientY,this.button=t.button,this.dstep=Math.max(this.camera.position[0],this.camera.position[1],this.camera.position[2])/100,null!=this.picker){var e=this.get2DCoords(t);if(this.picking=this.picker.find(e),this.picking){var r=this.picker.plist.length,i=1==r?r+" object has been selected":r+" objects have been selected";$("#title-id").html(i)}else this.picker.stop(),$("#title-id").html("Please select an object and drag it. (Alt key drags on the camera axis)")}},CameraInteractor.prototype.onMouseMove=function(t){if(this.lastX=this.x,this.lastY=this.y,this.x=t.clientX,this.y=t.clientY,this.dragging){this.ctrl=t.ctrlKey,this.alt=t.altKey;var e=this.x-this.lastX,r=this.y-this.lastY;return this.picking&&this.picker.moveCallback?void this.picker.moveCallback(this,e,r):void(0==this.button&&(this.alt?this.dolly(r):this.rotate(e,r)))}},CameraInteractor.prototype.onKeyDown=function(t){var e=this.camera;this.key=t.keyCode,this.ctrl=t.ctrlKey,this.ctrl||(38==this.key?e.changeElevation(10):40==this.key?e.changeElevation(-10):37==this.key?e.changeAzimuth(-10):39==this.key?e.changeAzimuth(10):87==this.key?(fovy&&(fovy+=5),console.info("FovY:"+fovy)):78==this.key&&(fovy&&(fovy-=5),console.info("FovY:"+fovy)))},CameraInteractor.prototype.onKeyUp=function(t){17==t.keyCode&&(this.ctrl=!1)},CameraInteractor.prototype.update=function(){var t=this,e=this.canvas;e.onmousedown=function(e){t.onMouseDown(e)},e.onmouseup=function(e){t.onMouseUp(e)},e.onmousemove=function(e){t.onMouseMove(e)},window.onkeydown=function(e){t.onKeyDown(e)},window.onkeyup=function(e){t.onKeyUp(e)}},CameraInteractor.prototype.dolly=function(t){t>0?this.dloc+=this.dstep:this.dloc-=this.dstep,this.camera.dolly(this.dloc)},CameraInteractor.prototype.rotate=function(t,e){var r=this.camera,i=this.canvas,n=-20/i.height,o=-20/i.width,a=t*o*this.MOTION_FACTOR,s=e*n*this.MOTION_FACTOR;r.changeAzimuth(a),r.changeElevation(s)},SceneTransforms.prototype.calculateModelView=function(){this.mvMatrix=this.camera.getViewTransform()},SceneTransforms.prototype.calculateNormal=function(){mat4.identity(this.nMatrix),mat4.set(this.mvMatrix,this.nMatrix),mat4.inverse(this.nMatrix),mat4.transpose(this.nMatrix)},SceneTransforms.prototype.calculatePerspective=function(){mat4.identity(this.pMatrix),mat4.perspective(30,c_width/c_height,.1,1e3,this.pMatrix)},SceneTransforms.prototype.init=function(){this.calculateModelView(),this.calculatePerspective(),this.calculateNormal()},SceneTransforms.prototype.updatePerspective=function(){mat4.perspective(30,c_width/c_height,.1,1e3,this.pMatrix)},SceneTransforms.prototype.setMatrixUniforms=function(){this.calculateNormal(),gl.uniformMatrix4fv(Program.uMVMatrix,!1,this.mvMatrix),gl.uniformMatrix4fv(Program.uPMatrix,!1,this.pMatrix),gl.uniformMatrix4fv(Program.uNMatrix,!1,this.nMatrix)},SceneTransforms.prototype.push=function(){var t=mat4.create();mat4.set(this.mvMatrix,t),this.stack.push(t)},SceneTransforms.prototype.pop=function(){0!=this.stack.length&&(this.mvMatrix=this.stack.pop())},NodeTree.prototype.getFather=function(){return this.father},NodeTree.prototype.setFather=function(t){t instanceof NodeTree?this.father=t:console.log("This is not a node")},NodeTree.prototype.getEntity=function(){return this.entity},NodeTree.prototype.setEntity=function(t){t instanceof Entity?this.entity=t:console.log("This is not an entity")},NodeTree.prototype.index=function(){return this.isRoot()?void 0:this.father.children.indexOf(this)},NodeTree.prototype.isRoot=function(){return""==this.father},NodeTree.prototype.childrenNumber=function(){return this.children.length},NodeTree.prototype.hasSibling=function(){return this.father.existsChild(this.father.getChild(this.index()+1))},NodeTree.prototype.nextSibling=function(){return!this.isRoot()&&this.hasSibling()?this.father.getChild(this.index()+1):null},NodeTree.prototype.addChild=function(t){t.setFather(this),this.children.push(t)},NodeTree.prototype.newChild=function(){return this.addChild(new NodeTree("",this,[]))},NodeTree.prototype.getChild=function(t){return this.existsChild(this.children[t])?this.children[t]:null},NodeTree.prototype.firstChild=function(){return this.getChild(0)},NodeTree.prototype.lastChild=function(){return this.getChild(this.childrenNumber()-1)},NodeTree.prototype.removeChild=function(t){this.existsChild(t)?this.children.splice(this.index(),1):!1},NodeTree.prototype.removeChildren=function(){this.children=[]},NodeTree.prototype.delete=function(){this.father.removeChild(this)},NodeTree.prototype.existsChild=function(t){return-1!=this.children.indexOf(t)},NodeTree.prototype.getChildren=function(){return this.children},NodeTree.prototype.draw=function(t){this.getEntity().beginDraw(t),this.getChildren().forEach(function(e){e.draw(t)}),this.getEntity().endDraw(t)},NodeTree.prototype.save=function(t){var e=this;e.getEntity()instanceof Light?Lights.add(e.getEntity(),e.getFather().getEntity().getPosition()):e.getEntity()instanceof Camera?Cameras.add(e.getEntity(),e.getFather().getEntity().getPosition()):e.getEntity()instanceof Mesh&&Scene.loadObject(e.getEntity().getFilename(),e.getEntity().getAlias(),e.getEntity().getAttributes(),t),e.getChildren().forEach(function(e){e.save(t)})},Tree.prototype.getRoot=function(){return this.root},Tree.prototype.setDraw=function(t){this.isDraw=t},Tree.prototype.getDraw=function(){return this.isDraw},Tree.prototype.draw=function(t){this.getRoot().getChildren().forEach(function(e){e.draw(t)})},Tree.prototype.save=function(t){this.getRoot().getChildren().forEach(function(e){e.save(t)})},Tree.prototype.saveEntities=function(t,e){var r=this;this.save(r.getRoot().firstChild(),t,e)};var WEBGLAPP_RENDER=void 0,WEBGLAPP_TIMER_ID=-1,WEBGLAPP_RENDER_RATE=16;Aubengine.prototype.getTree=function(){return this.tree},Aubengine.prototype.getRoot=function(){return this.tree.getRoot()},Aubengine.prototype.getTransforms=function(){return this.transforms},Aubengine.prototype.setUpEnvironment=function(t,e){this.changeColor(t,e),gl.enable(gl.DEPTH_TEST),gl.depthFunc(gl.LEQUAL),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),this.loadProgram()},Aubengine.prototype.changeColor=function(t,e){var r=Color.hex2rgb(t,e);gl.clearColor(r[0],r[1],r[2],r[3]),gl.clearDepth(1)},Aubengine.prototype.createCamera=function(t,e,r,i){var n=new Camera(t,CAMERA_ORBITING_TYPE,e,r,i);return n},Aubengine.prototype.setMainCamera=function(t){this.camera=t,this.interactor=new CameraInteractor(t,this.canvas),this.transforms=new SceneTransforms(t),transforms=this.transforms,interactor=this.interactor,transforms.init()},Aubengine.prototype.loadProgram=function(){Program.load()},Aubengine.prototype.createMesh=function(t,e,r){var i=new Mesh(t,e,r);return i},Aubengine.prototype.addFloor=function(t){Floor.build(80,2),Floor.Ka=[1,1,1],Floor.Kd=[.6,.6,.6],Floor.Ks=[1,1,1],Floor.Ni=1,Floor.Ns=1,Floor.d=1,Floor.illum=1,Floor.visible=t},Aubengine.prototype.createLight=function(t,e,r,i){if(null==t||null==e||null==r||null==i)alert("Light can not be created! Wrong parameters.");else{var n=new Light(t);n.setDiffuse(e),n.setAmbient(r),n.setSpecular(i)}return n},Aubengine.prototype.createTransformation=function(t,e,r,i){var n=new Transformation(t,e,r,i);return n},Aubengine.prototype.addNode=function(t,e){t.addChild(e)},Aubengine.prototype.createNode=function(t){var e=new NodeTree(t);return e},Aubengine.prototype.draw=function(){var t=this;gl.viewport(0,0,c_width,c_height),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),t.transforms.updatePerspective(),t.getTree().draw(t.transforms)},$(document).ready(function(){function t(){e=new Aubengine("the-canvas"),e.setUpEnvironment("#86DADA",1);var t=e.createCamera("camera1",[0,0,0],225,-15),r=(e.createCamera("camera2",[0,10,10],-700,-70),[0,3,40]),i=e.createTransformation("camera1Trans",r),n=[-25,25,-25],o=[25,25,-25],a=[-25,25,-25],s=[-25,-25,25],l=e.createTransformation("light1Trans",n),u=e.createTransformation("light2Trans",o),c=e.createTransformation("light2Trans",a),h=e.createTransformation("light2Trans",s),f=e.createLight("fleft",[.6,.6,.6],[0,0,0],[0,0,0]),g=e.createLight("fright",[.6,.6,.6],[0,0,0],[0,0,0]),m=e.createLight("nleft",[.6,.6,.6],[0,0,0],[0,0,0]),d=e.createLight("nright",[.6,.6,.6],[0,0,0],[0,0,0]),p=[0,1,0],v=[.2,.2,.2],y=[0,1.5,0],T=e.createTransformation("huertoTrans",p,v),x=e.createTransformation("huertoTrans",y,v),A=e.createMesh("/assets/huertoBase.json","huertoBase");A.setSpecularColor(204,102,0);var b=e.createMesh("/assets/huertoTop.json","huertoTop");b.setSpecularColor(255,204,153);var M=e.createMesh("/assets/vallaCompleta.json","valla"),N=[-5,3,2],R=[.4,.4,.4],E=e.createTransformation("tomatesTrans",N,R),C=e.createMesh("/assets/tomateBase.json","tomateBase");C.setSpecularColor(204,0,0);var L=e.createMesh("/assets/tomateTop.json","tomateTop");L.setSpecularColor(0,102,0);var _=e.createNode(i);e.addNode(e.getRoot(),_);var w=e.createNode(t);e.addNode(_,w);var F=e.createNode(l);e.addNode(e.getRoot(),F);var P=e.createNode(f);e.addNode(F,P);var S=e.createNode(u);e.addNode(e.getRoot(),S);var I=e.createNode(g);e.addNode(S,I);var O=e.createNode(c);e.addNode(e.getRoot(),O);var U=e.createNode(m);e.addNode(O,U);var D=e.createNode(h);e.addNode(e.getRoot(),D);var B=e.createNode(d);e.addNode(D,B);var j=e.createNode(T);e.addNode(e.getRoot(),j);var z=e.createNode(x),V=e.createNode(A),K=e.createNode(b),k=e.createNode(M);e.addNode(j,V),e.addNode(j,z),e.addNode(j,k),e.addNode(z,K);var Y=e.createNode(E);E.animate(5,180,E.translate,[E.position,[0,-.07,0]]),e.addNode(j,Y);var G=e.createNode(C),q=e.createNode(L);e.addNode(Y,G),e.addNode(Y,q),e.getTree().saveEntities(e),e.setMainCamera(Cameras.get(0));var H=new Animation(5,50,e.draw,null,e);H.startAnimation(),E.startAnimation()}var e;t(),resizeCanvas(),document.getElementById("draw").addEventListener("click",function(){e.draw()})});